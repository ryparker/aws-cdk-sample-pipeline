"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.dockerCredentialsInstallCommands = exports.DockerCredentialUsage = exports.DockerCredential = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const ec2 = require("@aws-cdk/aws-ec2");
const iam = require("@aws-cdk/aws-iam");
const core_1 = require("@aws-cdk/core");
/**
 * Represents credentials used to access a Docker registry.
 *
 * @stability stable
 */
class DockerCredential {
    /**
     * @stability stable
     */
    constructor(usages) {
        this.usages = usages;
    }
    /**
     * Creates a DockerCredential for DockerHub.
     *
     * Convenience method for `fromCustomRegistry('index.docker.io', opts)`.
     *
     * @stability stable
     */
    static dockerHub(secret, opts = {}) {
        return new ExternalDockerCredential('index.docker.io', secret, opts);
    }
    /**
     * Creates a DockerCredential for a registry, based on its domain name (e.g., 'www.example.com').
     *
     * @stability stable
     */
    static customRegistry(registryDomain, secret, opts = {}) {
        return new ExternalDockerCredential(registryDomain, secret, opts);
    }
    /**
     * Creates a DockerCredential for one or more ECR repositories.
     *
     * NOTE - All ECR repositories in the same account and region share a domain name
     * (e.g., 0123456789012.dkr.ecr.eu-west-1.amazonaws.com), and can only have one associated
     * set of credentials (and DockerCredential). Attempting to associate one set of credentials
     * with one ECR repo and another with another ECR repo in the same account and region will
     * result in failures when using these credentials in the pipeline.
     *
     * @stability stable
     */
    static ecr(repositories, opts) {
        return new EcrDockerCredential(repositories, opts !== null && opts !== void 0 ? opts : {});
    }
    /**
     * Determines if this credential is relevant to the input usage.
     * @internal
     */
    _applicableForUsage(usage) {
        return !this.usages || this.usages.includes(usage);
    }
}
exports.DockerCredential = DockerCredential;
_a = JSII_RTTI_SYMBOL_1;
DockerCredential[_a] = { fqn: "@aws-cdk/pipelines.DockerCredential", version: "1.121.0" };
/**
 * Defines which stages of a pipeline require the specified credentials.
 *
 * @stability stable
 */
var DockerCredentialUsage;
(function (DockerCredentialUsage) {
    DockerCredentialUsage["SYNTH"] = "SYNTH";
    DockerCredentialUsage["SELF_UPDATE"] = "SELF_UPDATE";
    DockerCredentialUsage["ASSET_PUBLISHING"] = "ASSET_PUBLISHING";
})(DockerCredentialUsage = exports.DockerCredentialUsage || (exports.DockerCredentialUsage = {}));
;
/** DockerCredential defined by registry domain and a secret */
class ExternalDockerCredential extends DockerCredential {
    constructor(registryDomain, secret, opts) {
        super(opts.usages);
        this.registryDomain = registryDomain;
        this.secret = secret;
        this.opts = opts;
    }
    grantRead(grantee, usage) {
        var _b;
        if (!this._applicableForUsage(usage)) {
            return;
        }
        if (this.opts.assumeRole) {
            grantee.grantPrincipal.addToPrincipalPolicy(new iam.PolicyStatement({
                actions: ['sts:AssumeRole'],
                resources: [this.opts.assumeRole.roleArn],
            }));
        }
        const role = (_b = this.opts.assumeRole) !== null && _b !== void 0 ? _b : grantee;
        this.secret.grantRead(role);
    }
    _renderCdkAssetsConfig() {
        var _b;
        return {
            [this.registryDomain]: {
                secretsManagerSecretId: this.secret.secretArn,
                secretsUsernameField: this.opts.secretUsernameField,
                secretsPasswordField: this.opts.secretPasswordField,
                assumeRoleArn: (_b = this.opts.assumeRole) === null || _b === void 0 ? void 0 : _b.roleArn,
            },
        };
    }
}
/** DockerCredential defined by a set of ECR repositories in the same account & region */
class EcrDockerCredential extends DockerCredential {
    constructor(repositories, opts) {
        super(opts.usages);
        this.repositories = repositories;
        this.opts = opts;
        if (repositories.length === 0) {
            throw new Error('must supply at least one `ecr.IRepository` to create an `EcrDockerCredential`');
        }
        this.registryDomain = core_1.Fn.select(0, core_1.Fn.split('/', repositories[0].repositoryUri));
    }
    grantRead(grantee, usage) {
        var _b;
        if (!this._applicableForUsage(usage)) {
            return;
        }
        if (this.opts.assumeRole) {
            grantee.grantPrincipal.addToPrincipalPolicy(new iam.PolicyStatement({
                actions: ['sts:AssumeRole'],
                resources: [this.opts.assumeRole.roleArn],
            }));
        }
        const role = (_b = this.opts.assumeRole) !== null && _b !== void 0 ? _b : grantee;
        this.repositories.forEach(repo => repo.grantPull(role));
    }
    _renderCdkAssetsConfig() {
        var _b;
        return {
            [this.registryDomain]: {
                ecrRepository: true,
                assumeRoleArn: (_b = this.opts.assumeRole) === null || _b === void 0 ? void 0 : _b.roleArn,
            },
        };
    }
}
/**
 * Creates a set of OS-specific buildspec installation commands for setting up the given
 * registries and associated credentials.
 *
 * @param registries - Registries to configure credentials for. It is an error to provide
 * multiple registries for the same domain.
 * @param osType - (optional) Defaults to Linux.
 * @returns An array of commands to configure cdk-assets to use these credentials.
 */
function dockerCredentialsInstallCommands(usage, registries, osType) {
    const relevantRegistries = (registries !== null && registries !== void 0 ? registries : []).filter(reg => reg._applicableForUsage(usage));
    if (!relevantRegistries || relevantRegistries.length === 0) {
        return [];
    }
    const domainCredentials = relevantRegistries.reduce(function (map, registry) {
        Object.assign(map, registry._renderCdkAssetsConfig());
        return map;
    }, {});
    const cdkAssetsConfigFile = {
        version: '1.0',
        domainCredentials,
    };
    const windowsCommands = [
        'mkdir %USERPROFILE%\\.cdk',
        `echo '${JSON.stringify(cdkAssetsConfigFile)}' > %USERPROFILE%\\.cdk\\cdk-docker-creds.json`,
    ];
    const linuxCommands = [
        'mkdir $HOME/.cdk',
        `echo '${JSON.stringify(cdkAssetsConfigFile)}' > $HOME/.cdk/cdk-docker-creds.json`,
    ];
    if (osType === 'both') {
        return [
            // These tags are magic and will be stripped when rendering the project
            ...windowsCommands.map(c => `!WINDOWS!${c}`),
            ...linuxCommands.map(c => `!LINUX!${c}`),
        ];
    }
    else if (osType === ec2.OperatingSystemType.WINDOWS) {
        return windowsCommands;
    }
    else {
        return linuxCommands;
    }
}
exports.dockerCredentialsInstallCommands = dockerCredentialsInstallCommands;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9ja2VyLWNyZWRlbnRpYWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZG9ja2VyLWNyZWRlbnRpYWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsd0NBQXdDO0FBRXhDLHdDQUF3QztBQUV4Qyx3Q0FBbUM7Ozs7OztBQUduQyxNQUFzQixnQkFBZ0I7Ozs7SUFtQnBDLFlBQStCLE1BQWdDO1FBQWhDLFdBQU0sR0FBTixNQUFNLENBQTBCO0lBQUksQ0FBQzs7Ozs7Ozs7SUFqQjdELE1BQU0sQ0FBQyxTQUFTLENBQUMsTUFBOEIsRUFBRSxPQUF3QyxFQUFFO1FBQ2hHLE9BQU8sSUFBSSx3QkFBd0IsQ0FBQyxpQkFBaUIsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDdkUsQ0FBQzs7Ozs7O0lBR00sTUFBTSxDQUFDLGNBQWMsQ0FDMUIsY0FBc0IsRUFDdEIsTUFBOEIsRUFDOUIsT0FBd0MsRUFBRTtRQUMxQyxPQUFPLElBQUksd0JBQXdCLENBQUMsY0FBYyxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNwRSxDQUFDOzs7Ozs7Ozs7Ozs7SUFHTSxNQUFNLENBQUMsR0FBRyxDQUFDLFlBQStCLEVBQUUsSUFBaUM7UUFDbEYsT0FBTyxJQUFJLG1CQUFtQixDQUFDLFlBQVksRUFBRSxJQUFJLGFBQUosSUFBSSxjQUFKLElBQUksR0FBSSxFQUFFLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBSUQ7OztPQUdHO0lBQ0ksbUJBQW1CLENBQUMsS0FBNEI7UUFDckQsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDckQsQ0FBQzs7QUEzQkgsNENBc0NDOzs7Ozs7OztBQXVCRCxJQUFZLHFCQU9YO0FBUEQsV0FBWSxxQkFBcUI7SUFFL0Isd0NBQWUsQ0FBQTtJQUVmLG9EQUEyQixDQUFBO0lBRTNCLDhEQUFxQyxDQUFBO0FB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O0tBQzdGLENBQUM7SUFFRixNQUFNLGFBQWEsR0FBRztRQUNwQixrQkFBa0I7UUFDbEIsU0FBUyxJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixDQUFDLHNDQUFzQztLQUNuRixDQUFDO0lBRUYsSUFBSSxNQUFNLEtBQUssTUFBTSxFQUFFO1FBQ3JCLE9BQU87WUFDTCx1RUFBdUU7WUFDdkUsR0FBRyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQztZQUM1QyxHQUFHLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO1NBQ3pDLENBQUM7S0FDSDtTQUFNLElBQUksTUFBTSxLQUFLLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLEVBQUU7UUFDckQsT0FBTyxlQUFlLENBQUM7S0FDeEI7U0FBTTtRQUNMLE9BQU8sYUFBYSxDQUFDO0tBQ3RCO0FBQ0gsQ0FBQztBQXRDRCw0RUFzQ0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBlYzIgZnJvbSAnQGF3cy1jZGsvYXdzLWVjMic7XG5pbXBvcnQgKiBhcyBlY3IgZnJvbSAnQGF3cy1jZGsvYXdzLWVjcic7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSAnQGF3cy1jZGsvYXdzLWlhbSc7XG5pbXBvcnQgKiBhcyBzZWNyZXRzbWFuYWdlciBmcm9tICdAYXdzLWNkay9hd3Mtc2VjcmV0c21hbmFnZXInO1xuaW1wb3J0IHsgRm4gfSBmcm9tICdAYXdzLWNkay9jb3JlJztcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIERvY2tlckNyZWRlbnRpYWwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICBwdWJsaWMgc3RhdGljIGRvY2tlckh1YihzZWNyZXQ6IHNlY3JldHNtYW5hZ2VyLklTZWNyZXQsIG9wdHM6IEV4dGVybmFsRG9ja2VyQ3JlZGVudGlhbE9wdGlvbnMgPSB7fSk6IERvY2tlckNyZWRlbnRpYWwge1xuICAgIHJldHVybiBuZXcgRXh0ZXJuYWxEb2NrZXJDcmVkZW50aWFsKCdpbmRleC5kb2NrZXIuaW8nLCBzZWNyZXQsIG9wdHMpO1xuICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICBwdWJsaWMgc3RhdGljIGN1c3RvbVJlZ2lzdHJ5KFxuICAgIHJlZ2lzdHJ5RG9tYWluOiBzdHJpbmcsXG4gICAgc2VjcmV0OiBzZWNyZXRzbWFuYWdlci5JU2VjcmV0LFxuICAgIG9wdHM6IEV4dGVybmFsRG9ja2VyQ3JlZGVudGlhbE9wdGlvbnMgPSB7fSk6IERvY2tlckNyZWRlbnRpYWwge1xuICAgIHJldHVybiBuZXcgRXh0ZXJuYWxEb2NrZXJDcmVkZW50aWFsKHJlZ2lzdHJ5RG9tYWluLCBzZWNyZXQsIG9wdHMpO1xuICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcHVibGljIHN0YXRpYyBlY3IocmVwb3NpdG9yaWVzOiBlY3IuSVJlcG9zaXRvcnlbXSwgb3B0cz86IEVjckRvY2tlckNyZWRlbnRpYWxPcHRpb25zKTogRG9ja2VyQ3JlZGVudGlhbCB7XG4gICAgcmV0dXJuIG5ldyBFY3JEb2NrZXJDcmVkZW50aWFsKHJlcG9zaXRvcmllcywgb3B0cyA/PyB7fSk7XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgcmVhZG9ubHkgdXNhZ2VzPzogRG9ja2VyQ3JlZGVudGlhbFVzYWdlW10pIHsgfVxuXG4gIC8qKlxuICAgKiBEZXRlcm1pbmVzIGlmIHRoaXMgY3JlZGVudGlhbCBpcyByZWxldmFudCB0byB0aGUgaW5wdXQgdXNhZ2UuXG4gICAqIEBpbnRlcm5hbFxuICAgKi9cbiAgcHVibGljIF9hcHBsaWNhYmxlRm9yVXNhZ2UodXNhZ2U6IERvY2tlckNyZWRlbnRpYWxVc2FnZSkge1xuICAgIHJldHVybiAhdGhpcy51c2FnZXMgfHwgdGhpcy51c2FnZXMuaW5jbHVkZXModXNhZ2UpO1xuICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICBwdWJsaWMgYWJzdHJhY3QgZ3JhbnRSZWFkKGdyYW50ZWU6IGlhbS5JR3JhbnRhYmxlLCB1c2FnZTogRG9ja2VyQ3JlZGVudGlhbFVzYWdlKTogdm9pZDtcblxuICAvKipcbiAgICogQ3JlYXRlcyBhbmQgcmV0dXJucyB0aGUgY3JlZGVudGlhbCBjb25maWd1cmF0aW9uLCB0byBiZSB1c2VkIGJ5IGBjZGstYXNzZXRzYFxuICAgKiB0byBzdXBwb3J0IHRoZSBgZG9ja2VyLWNyZWRlbnRpYWwtY2RrLWFzc2V0c2AgdG9vbCBmb3IgYGRvY2tlciBsb2dpbmAuXG4gICAqIEBpbnRlcm5hbFxuICAgKi9cbiAgcHVibGljIGFic3RyYWN0IF9yZW5kZXJDZGtBc3NldHNDb25maWcoKTogRG9ja2VyQ3JlZGVudGlhbENyZWRlbnRpYWxTb3VyY2Vcbn1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5leHBvcnQgaW50ZXJmYWNlIEV4dGVybmFsRG9ja2VyQ3JlZGVudGlhbE9wdGlvbnMge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSBzZWNyZXRVc2VybmFtZUZpZWxkPzogc3RyaW5nO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcmVhZG9ubHkgc2VjcmV0UGFzc3dvcmRGaWVsZD86IHN0cmluZztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSBhc3N1bWVSb2xlPzogaWFtLklSb2xlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcmVhZG9ubHkgdXNhZ2VzPzogRG9ja2VyQ3JlZGVudGlhbFVzYWdlW107XG59XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG5leHBvcnQgaW50ZXJmYWNlIEVjckRvY2tlckNyZWRlbnRpYWxPcHRpb25zIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICByZWFkb25seSBhc3N1bWVSb2xlPzogaWFtLklSb2xlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgcmVhZG9ubHkgdXNhZ2VzPzogRG9ja2VyQ3JlZGVudGlhbFVzYWdlW107XG59XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuZXhwb3J0IGVudW0gRG9ja2VyQ3JlZGVudGlhbFVzYWdlIHtcbiAgICAgICAgICAgICAgICAgICAgXG4gIFNZTlRIID0gJ1NZTlRIJyxcbiAgICAgICAgICAgICAgICAgICAgXG4gIFNFTEZfVVBEQVRFID0gJ1NFTEZfVVBEQVRFJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgQVNTRVRfUFVCTElTSElORyA9ICdBU1NFVF9QVUJMSVNISU5HJyxcbn07XG5cbi8qKiBEb2NrZXJDcmVkZW50aWFsIGRlZmluZWQgYnkgcmVnaXN0cnkgZG9tYWluIGFuZCBhIHNlY3JldCAqL1xuY2xhc3MgRXh0ZXJuYWxEb2NrZXJDcmVkZW50aWFsIGV4dGVuZHMgRG9ja2VyQ3JlZGVudGlhbCB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcmVnaXN0cnlEb21haW46IHN0cmluZyxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNlY3JldDogc2VjcmV0c21hbmFnZXIuSVNlY3JldCxcbiAgICBwcml2YXRlIHJlYWRvbmx5IG9wdHM6IEV4dGVybmFsRG9ja2VyQ3JlZGVudGlhbE9wdGlvbnMpIHtcbiAgICBzdXBlcihvcHRzLnVzYWdlcyk7XG4gIH1cblxuICBwdWJsaWMgZ3JhbnRSZWFkKGdyYW50ZWU6IGlhbS5JR3JhbnRhYmxlLCB1c2FnZTogRG9ja2VyQ3JlZGVudGlhbFVzYWdlKSB7XG4gICAgaWYgKCF0aGlzLl9hcHBsaWNhYmxlRm9yVXNhZ2UodXNhZ2UpKSB7IHJldHVybjsgfVxuXG4gICAgaWYgKHRoaXMub3B0cy5hc3N1bWVSb2xlKSB7XG4gICAgICBncmFudGVlLmdyYW50UHJpbmNpcGFsLmFkZFRvUHJpbmNpcGFsUG9saWN5KG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgYWN0aW9uczogWydzdHM6QXNzdW1lUm9sZSddLFxuICAgICAgICByZXNvdXJjZXM6IFt0aGlzLm9wdHMuYXNzdW1lUm9sZS5yb2xlQXJuXSxcbiAgICAgIH0pKTtcbiAgICB9XG4gICAgY29uc3Qgcm9sZSA9IHRoaXMub3B0cy5hc3N1bWVSb2xlID8/IGdyYW50ZWU7XG4gICAgdGhpcy5zZWNyZXQuZ3JhbnRSZWFkKHJvbGUpO1xuICB9XG5cbiAgcHVibGljIF9yZW5kZXJDZGtBc3NldHNDb25maWcoKTogRG9ja2VyQ3JlZGVudGlhbENyZWRlbnRpYWxTb3VyY2Uge1xuICAgIHJldHVybiB7XG4gICAgICBbdGhpcy5yZWdpc3RyeURvbWFpbl06IHtcbiAgICAgICAgc2VjcmV0c01hbmFnZXJTZWNyZXRJZDogdGhpcy5zZWNyZXQuc2VjcmV0QXJuLFxuICAgICAgICBzZWNyZXRzVXNlcm5hbWVGaWVsZDogdGhpcy5vcHRzLnNlY3JldFVzZXJuYW1lRmllbGQsXG4gICAgICAgIHNlY3JldHNQYXNzd29yZEZpZWxkOiB0aGlzLm9wdHMuc2VjcmV0UGFzc3dvcmRGaWVsZCxcbiAgICAgICAgYXNzdW1lUm9sZUFybjogdGhpcy5vcHRzLmFzc3VtZVJvbGU/LnJvbGVBcm4sXG4gICAgICB9LFxuICAgIH07XG4gIH1cbn1cblxuLyoqIERvY2tlckNyZWRlbnRpYWwgZGVmaW5lZCBieSBhIHNldCBvZiBFQ1IgcmVwb3NpdG9yaWVzIGluIHRoZSBzYW1lIGFjY291bnQgJiByZWdpb24gKi9cbmNsYXNzIEVjckRvY2tlckNyZWRlbnRpYWwgZXh0ZW5kcyBEb2NrZXJDcmVkZW50aWFsIHtcbiAgcHVibGljIHJlYWRvbmx5IHJlZ2lzdHJ5RG9tYWluOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSByZXBvc2l0b3JpZXM6IGVjci5JUmVwb3NpdG9yeVtdLCBwcml2YXRlIHJlYWRvbmx5IG9wdHM6IEVjckRvY2tlckNyZWRlbnRpYWxPcHRpb25zKSB7XG4gICAgc3VwZXIob3B0cy51c2FnZXMpO1xuXG4gICAgaWYgKHJlcG9zaXRvcmllcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignbXVzdCBzdXBwbHkgYXQgbGVhc3Qgb25lIGBlY3IuSVJlcG9zaXRvcnlgIHRvIGNyZWF0ZSBhbiBgRWNyRG9ja2VyQ3JlZGVudGlhbGAnKTtcbiAgICB9XG4gICAgdGhpcy5yZWdpc3RyeURvbWFpbiA9IEZuLnNlbGVjdCgwLCBGbi5zcGxpdCgnLycsIHJlcG9zaXRvcmllc1swXS5yZXBvc2l0b3J5VXJpKSk7XG4gIH1cblxuICBwdWJsaWMgZ3JhbnRSZWFkKGdyYW50ZWU6IGlhbS5JR3JhbnRhYmxlLCB1c2FnZTogRG9ja2VyQ3JlZGVudGlhbFVzYWdlKSB7XG4gICAgaWYgKCF0aGlzLl9hcHBsaWNhYmxlRm9yVXNhZ2UodXNhZ2UpKSB7IHJldHVybjsgfVxuXG4gICAgaWYgKHRoaXMub3B0cy5hc3N1bWVSb2xlKSB7XG4gICAgICBncmFudGVlLmdyYW50UHJpbmNpcGFsLmFkZFRvUHJpbmNpcGFsUG9saWN5KG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgYWN0aW9uczogWydzdHM6QXNzdW1lUm9sZSddLFxuICAgICAgICByZXNvdXJjZXM6IFt0aGlzLm9wdHMuYXNzdW1lUm9sZS5yb2xlQXJuXSxcbiAgICAgIH0pKTtcbiAgICB9XG4gICAgY29uc3Qgcm9sZSA9IHRoaXMub3B0cy5hc3N1bWVSb2xlID8/IGdyYW50ZWU7XG4gICAgdGhpcy5yZXBvc2l0b3JpZXMuZm9yRWFjaChyZXBvID0+IHJlcG8uZ3JhbnRQdWxsKHJvbGUpKTtcbiAgfVxuXG4gIHB1YmxpYyBfcmVuZGVyQ2RrQXNzZXRzQ29uZmlnKCk6IERvY2tlckNyZWRlbnRpYWxDcmVkZW50aWFsU291cmNlIHtcbiAgICByZXR1cm4ge1xuICAgICAgW3RoaXMucmVnaXN0cnlEb21haW5dOiB7XG4gICAgICAgIGVjclJlcG9zaXRvcnk6IHRydWUsXG4gICAgICAgIGFzc3VtZVJvbGVBcm46IHRoaXMub3B0cy5hc3N1bWVSb2xlPy5yb2xlQXJuLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG59XG5cbi8qKiBGb3JtYXQgZm9yIHRoZSBDREsgYXNzZXRzIGNvbmZpZy4gU2VlIHRoZSBjZGstYXNzZXRzIGBEb2NrZXJEb21haW5DcmVkZW50aWFsU291cmNlYCAqL1xuaW50ZXJmYWNlIERvY2tlckNyZWRlbnRpYWxDcmVkZW50aWFsU291cmNlIHtcbiAgcmVhZG9ubHkgc2VjcmV0c01hbmFnZXJTZWNyZXRJZD86IHN0cmluZztcbiAgcmVhZG9ubHkgc2VjcmV0c1VzZXJuYW1lRmllbGQ/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IHNlY3JldHNQYXNzd29yZEZpZWxkPzogc3RyaW5nO1xuICByZWFkb25seSBlY3JSZXBvc2l0b3J5PzogYm9vbGVhbjtcbiAgcmVhZG9ubHkgYXNzdW1lUm9sZUFybj86IHN0cmluZztcbn1cblxuLyoqXG4gKiBDcmVhdGVzIGEgc2V0IG9mIE9TLXNwZWNpZmljIGJ1aWxkc3BlYyBpbnN0YWxsYXRpb24gY29tbWFuZHMgZm9yIHNldHRpbmcgdXAgdGhlIGdpdmVuXG4gKiByZWdpc3RyaWVzIGFuZCBhc3NvY2lhdGVkIGNyZWRlbnRpYWxzLlxuICpcbiAqIEBwYXJhbSByZWdpc3RyaWVzIC0gUmVnaXN0cmllcyB0byBjb25maWd1cmUgY3JlZGVudGlhbHMgZm9yLiBJdCBpcyBhbiBlcnJvciB0byBwcm92aWRlXG4gKiBtdWx0aXBsZSByZWdpc3RyaWVzIGZvciB0aGUgc2FtZSBkb21haW4uXG4gKiBAcGFyYW0gb3NUeXBlIC0gKG9wdGlvbmFsKSBEZWZhdWx0cyB0byBMaW51eC5cbiAqIEByZXR1cm5zIEFuIGFycmF5IG9mIGNvbW1hbmRzIHRvIGNvbmZpZ3VyZSBjZGstYXNzZXRzIHRvIHVzZSB0aGVzZSBjcmVkZW50aWFscy5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGRvY2tlckNyZWRlbnRpYWxzSW5zdGFsbENvbW1hbmRzKFxuICB1c2FnZTogRG9ja2VyQ3JlZGVudGlhbFVzYWdlLFxuICByZWdpc3RyaWVzPzogRG9ja2VyQ3JlZGVudGlhbFtdLFxuICBvc1R5cGU/OiBlYzIuT3BlcmF0aW5nU3lzdGVtVHlwZSB8ICdib3RoJyk6IHN0cmluZ1tdIHtcblxuICBjb25zdCByZWxldmFudFJlZ2lzdHJpZXMgPSAocmVnaXN0cmllcyA/PyBbXSkuZmlsdGVyKHJlZyA9PiByZWcuX2FwcGxpY2FibGVGb3JVc2FnZSh1c2FnZSkpO1xuICBpZiAoIXJlbGV2YW50UmVnaXN0cmllcyB8fCByZWxldmFudFJlZ2lzdHJpZXMubGVuZ3RoID09PSAwKSB7IHJldHVybiBbXTsgfVxuXG4gIGNvbnN0IGRvbWFpbkNyZWRlbnRpYWxzID0gcmVsZXZhbnRSZWdpc3RyaWVzLnJlZHVjZShmdW5jdGlvbiAobWFwOiBSZWNvcmQ8c3RyaW5nLCBhbnk+LCByZWdpc3RyeSkge1xuICAgIE9iamVjdC5hc3NpZ24obWFwLCByZWdpc3RyeS5fcmVuZGVyQ2RrQXNzZXRzQ29uZmlnKCkpO1xuICAgIHJldHVybiBtYXA7XG4gIH0sIHt9KTtcbiAgY29uc3QgY2RrQXNzZXRzQ29uZmlnRmlsZSA9IHtcbiAgICB2ZXJzaW9uOiAnMS4wJyxcbiAgICBkb21haW5DcmVkZW50aWFscyxcbiAgfTtcblxuICBjb25zdCB3aW5kb3dzQ29tbWFuZHMgPSBbXG4gICAgJ21rZGlyICVVU0VSUFJPRklMRSVcXFxcLmNkaycsXG4gICAgYGVjaG8gJyR7SlNPTi5zdHJpbmdpZnkoY2RrQXNzZXRzQ29uZmlnRmlsZSl9JyA+ICVVU0VSUFJPRklMRSVcXFxcLmNka1xcXFxjZGstZG9ja2VyLWNyZWRzLmpzb25gLFxuICBdO1xuXG4gIGNvbnN0IGxpbnV4Q29tbWFuZHMgPSBbXG4gICAgJ21rZGlyICRIT01FLy5jZGsnLFxuICAgIGBlY2hvICcke0pTT04uc3RyaW5naWZ5KGNka0Fzc2V0c0NvbmZpZ0ZpbGUpfScgPiAkSE9NRS8uY2RrL2Nkay1kb2NrZXItY3JlZHMuanNvbmAsXG4gIF07XG5cbiAgaWYgKG9zVHlwZSA9PT0gJ2JvdGgnKSB7XG4gICAgcmV0dXJuIFtcbiAgICAgIC8vIFRoZXNlIHRhZ3MgYXJlIG1hZ2ljIGFuZCB3aWxsIGJlIHN0cmlwcGVkIHdoZW4gcmVuZGVyaW5nIHRoZSBwcm9qZWN0XG4gICAgICAuLi53aW5kb3dzQ29tbWFuZHMubWFwKGMgPT4gYCFXSU5ET1dTISR7Y31gKSxcbiAgICAgIC4uLmxpbnV4Q29tbWFuZHMubWFwKGMgPT4gYCFMSU5VWCEke2N9YCksXG4gICAgXTtcbiAgfSBlbHNlIGlmIChvc1R5cGUgPT09IGVjMi5PcGVyYXRpbmdTeXN0ZW1UeXBlLldJTkRPV1MpIHtcbiAgICByZXR1cm4gd2luZG93c0NvbW1hbmRzO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBsaW51eENvbW1hbmRzO1xuICB9XG59XG4iXX0=