"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ApplicationSecurityCheck = void 0;
const path = require("path");
const codebuild = require("@aws-cdk/aws-codebuild");
const iam = require("@aws-cdk/aws-iam");
const lambda = require("@aws-cdk/aws-lambda");
const core_1 = require("@aws-cdk/core");
// keep this import separate from other imports to reduce chance for merge conflicts with v2-main
// eslint-disable-next-line no-duplicate-imports, import/order
const core_2 = require("@aws-cdk/core");
/**
 * A construct containing both the Lambda and CodeBuild Project
 * needed to conduct a security check on any given application stage.
 *
 * The Lambda acts as an auto approving mechanism that should only be
 * triggered when the CodeBuild Project registers no security changes.
 *
 * The CodeBuild Project runs a security diff on the application stage,
 * and exports the link to the console of the project.
 */
class ApplicationSecurityCheck extends core_2.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        core_1.Tags.of(props.codePipeline).add('SECURITY_CHECK', 'ALLOW_APPROVE', {
            includeResourceTypes: ['AWS::CodePipeline::Pipeline'],
        });
        this.preApproveLambda = new lambda.Function(this, 'CDKPipelinesAutoApprove', {
            handler: 'index.handler',
            runtime: lambda.Runtime.NODEJS_14_X,
            code: lambda.Code.fromAsset(path.resolve(__dirname, 'approve-lambda')),
            timeout: core_1.Duration.minutes(5),
        });
        this.preApproveLambda.addToRolePolicy(new iam.PolicyStatement({
            actions: ['codepipeline:GetPipelineState', 'codepipeline:PutApprovalResult'],
            conditions: {
                StringEquals: {
                    'aws:ResourceTag/SECURITY_CHECK': 'ALLOW_APPROVE',
                },
            },
            resources: ['*'],
        }));
        const invokeLambda = 'aws lambda invoke' +
            ` --function-name ${this.preApproveLambda.functionName}` +
            ' --invocation-type Event' +
            ' --payload "$payload"' +
            ' lambda.out';
        const message = [
            'An upcoming change would broaden security changes in $PIPELINE_NAME.',
            'Review and approve the changes in CodePipeline to proceed with the deployment.',
            '',
            'Review the changes in CodeBuild:',
            '',
            '$LINK',
            '',
            'Approve the changes in CodePipeline (stage $STAGE_NAME, action $ACTION_NAME):',
            '',
            '$PIPELINE_LINK',
        ];
        const publishNotification = 'aws sns publish' +
            ' --topic-arn $NOTIFICATION_ARN' +
            ' --subject "$NOTIFICATION_SUBJECT"' +
            ` --message "${message.join('\n')}"`;
        this.cdkDiffProject = new codebuild.Project(this, 'CDKSecurityCheck', {
            buildSpec: codebuild.BuildSpec.fromObject({
                version: 0.2,
                phases: {
                    build: {
                        commands: [
                            'npm install -g aws-cdk',
                            // $CODEBUILD_INITIATOR will always be Code Pipeline and in the form of:
                            // "codepipeline/example-pipeline-name-Xxx"
                            'export PIPELINE_NAME="$(node -pe \'`${process.env.CODEBUILD_INITIATOR}`.split("/")[1]\')"',
                            'payload="$(node -pe \'JSON.stringify({ "PipelineName": process.env.PIPELINE_NAME, "StageName": process.env.STAGE_NAME, "ActionName": process.env.ACTION_NAME })\' )"',
                            // ARN: "arn:aws:codebuild:$region:$account_id:build/$project_name:$project_execution_id$"
                            'ARN=$CODEBUILD_BUILD_ARN',
                            'REGION="$(node -pe \'`${process.env.ARN}`.split(":")[3]\')"',
                            'ACCOUNT_ID="$(node -pe \'`${process.env.ARN}`.split(":")[4]\')"',
                            'PROJECT_NAME="$(node -pe \'`${process.env.ARN}`.split(":")[5].split("/")[1]\')"',
                            'PROJECT_ID="$(node -pe \'`${process.env.ARN}`.split(":")[6]\')"',
                            // Manual Approval adds 'http/https' to the resolved link
                            'export LINK="https://$REGION.console.aws.amazon.com/codesuite/codebuild/$ACCOUNT_ID/projects/$PROJECT_NAME/build/$PROJECT_NAME:$PROJECT_ID/?region=$REGION"',
                            'export PIPELINE_LINK="https://$REGION.console.aws.amazon.com/codesuite/codepipeline/pipelines/$PIPELINE_NAME/view?region=$REGION"',
                            // Run invoke only if cdk diff passes (returns exit code 0)
                            // 0 -> true, 1 -> false
                            ifElse({
                                condition: 'cdk diff -a . --security-only --fail $STAGE_PATH/\\*',
                                thenStatements: [
                                    invokeLambda,
                                    'export MESSAGE="No security-impacting changes detected."',
                                ],
                                elseStatements: [
                                    `[ -z "\${NOTIFICATION_ARN}" ] || ${publishNotification}`,
                                    'export MESSAGE="Deployment would make security-impacting changes. Click the link below to inspect them, then click Approve if all changes are expected."',
                                ],
                            }),
                        ],
                    },
                },
                env: {
                    'exported-variables': [
                        'LINK',
                        'MESSAGE',
                    ],
                },
            }),
        });
        // this is needed to check the status the stacks when doing `cdk diff`
        this.cdkDiffProject.addToRolePolicy(new iam.PolicyStatement({
            actions: ['sts:AssumeRole'],
            resources: ['*'],
            conditions: {
                'ForAnyValue:StringEquals': {
                    'iam:ResourceTag/aws-cdk:bootstrap-role': ['deploy'],
                },
            },
        }));
        this.preApproveLambda.grantInvoke(this.cdkDiffProject);
    }
}
exports.ApplicationSecurityCheck = ApplicationSecurityCheck;
const ifElse = ({ condition, thenStatements, elseStatements }) => {
    let statement = thenStatements.reduce((acc, ifTrue) => {
        return `${acc} ${ifTrue};`;
    }, `if ${condition}; then`);
    if (elseStatements) {
        statement = elseStatements.reduce((acc, ifFalse) => {
            return `${acc} ${ifFalse};`;
        }, `${statement} else`);
    }
    return `${statement} fi`;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbGljYXRpb24tc2VjdXJpdHktY2hlY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhcHBsaWNhdGlvbi1zZWN1cml0eS1jaGVjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw2QkFBNkI7QUFDN0Isb0RBQW9EO0FBRXBELHdDQUF3QztBQUN4Qyw4Q0FBOEM7QUFDOUMsd0NBQStDO0FBRy9DLGlHQUFpRztBQUNqRyw4REFBOEQ7QUFDOUQsd0NBQTJEO0FBYzNEOzs7Ozs7Ozs7R0FTRztBQUNILE1BQWEsd0JBQXlCLFNBQVEsZ0JBQWE7SUFxQnpELFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBb0M7UUFDNUUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixXQUFJLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsZUFBZSxFQUFFO1lBQ2pFLG9CQUFvQixFQUFFLENBQUMsNkJBQTZCLENBQUM7U0FDdEQsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUseUJBQXlCLEVBQUU7WUFDM0UsT0FBTyxFQUFFLGVBQWU7WUFDeEIsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVztZQUNuQyxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztZQUN0RSxPQUFPLEVBQUUsZUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7U0FDN0IsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGVBQWUsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxlQUFlLENBQUM7WUFDNUQsT0FBTyxFQUFFLENBQUMsK0JBQStCLEVBQUUsZ0NBQWdDLENBQUM7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RUFBRSxFQUFFO1lBQ2pELE9BQU8sR0FBRyxHQUFHLElBQUksT0FBTyxHQUFHLENBQUM7UUFDOUIsQ0FBQyxFQUFFLEdBQUcsU0FBUyxPQUFPLENBQUMsQ0FBQztLQUN6QjtJQUVELE9BQU8sR0FBRyxTQUFTLEtBQUssQ0FBQztBQUMzQixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0ICogYXMgY29kZWJ1aWxkIGZyb20gJ0Bhd3MtY2RrL2F3cy1jb2RlYnVpbGQnO1xuaW1wb3J0ICogYXMgY3AgZnJvbSAnQGF3cy1jZGsvYXdzLWNvZGVwaXBlbGluZSc7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSAnQGF3cy1jZGsvYXdzLWlhbSc7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSAnQGF3cy1jZGsvYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBEdXJhdGlvbiwgVGFncyB9IGZyb20gJ0Bhd3MtY2RrL2NvcmUnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5cbi8vIGtlZXAgdGhpcyBpbXBvcnQgc2VwYXJhdGUgZnJvbSBvdGhlciBpbXBvcnRzIHRvIHJlZHVjZSBjaGFuY2UgZm9yIG1lcmdlIGNvbmZsaWN0cyB3aXRoIHYyLW1haW5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1kdXBsaWNhdGUtaW1wb3J0cywgaW1wb3J0L29yZGVyXG5pbXBvcnQgeyBDb25zdHJ1Y3QgYXMgQ29yZUNvbnN0cnVjdCB9IGZyb20gJ0Bhd3MtY2RrL2NvcmUnO1xuXG4vKipcbiAqIFByb3BlcnRpZXMgZm9yIGFuIEFwcGxpY2F0aW9uU2VjdXJpdHlDaGVja1xuICovXG5leHBvcnQgaW50ZXJmYWNlIEFwcGxpY2F0aW9uU2VjdXJpdHlDaGVja1Byb3BzIHtcbiAgLyoqXG4gICAqIFRoZSBwaXBlbGluZSB0aGF0IHdpbGwgYmUgYXV0b21hdGljYWxseSBhcHByb3ZlZFxuICAgKlxuICAgKiBXaWxsIGhhdmUgYSB0YWcgYWRkZWQgdG8gaXQuXG4gICAqL1xuICByZWFkb25seSBjb2RlUGlwZWxpbmU6IGNwLlBpcGVsaW5lO1xufVxuXG4vKipcbiAqIEEgY29uc3RydWN0IGNvbnRhaW5pbmcgYm90aCB0aGUgTGFtYmRhIGFuZCBDb2RlQnVpbGQgUHJvamVjdFxuICogbmVlZGVkIHRvIGNvbmR1Y3QgYSBzZWN1cml0eSBjaGVjayBvbiBhbnkgZ2l2ZW4gYXBwbGljYXRpb24gc3RhZ2UuXG4gKlxuICogVGhlIExhbWJkYSBhY3RzIGFzIGFuIGF1dG8gYXBwcm92aW5nIG1lY2hhbmlzbSB0aGF0IHNob3VsZCBvbmx5IGJlXG4gKiB0cmlnZ2VyZWQgd2hlbiB0aGUgQ29kZUJ1aWxkIFByb2plY3QgcmVnaXN0ZXJzIG5vIHNlY3VyaXR5IGNoYW5nZXMuXG4gKlxuICogVGhlIENvZGVCdWlsZCBQcm9qZWN0IHJ1bnMgYSBzZWN1cml0eSBkaWZmIG9uIHRoZSBhcHBsaWNhdGlvbiBzdGFnZSxcbiAqIGFuZCBleHBvcnRzIHRoZSBsaW5rIHRvIHRoZSBjb25zb2xlIG9mIHRoZSBwcm9qZWN0LlxuICovXG5leHBvcnQgY2xhc3MgQXBwbGljYXRpb25TZWN1cml0eUNoZWNrIGV4dGVuZHMgQ29yZUNvbnN0cnVjdCB7XG4gIC8qKlxuICAgKiBBIGxhbWJkYSBmdW5jdGlvbiB0aGF0IGFwcHJvdmVzIGEgTWFudWFsIEFwcHJvdmFsIEFjdGlvbiwgZ2l2ZW5cbiAgICogdGhlIGZvbGxvd2luZyBwYXlsb2FkOlxuICAgKlxuICAgKiB7XG4gICAqICBcIlBpcGVsaW5lTmFtZVwiOiBbQ29kZVBpcGVsaW5lTmFtZV0sXG4gICAqICBcIlN0YWdlTmFtZVwiOiBbQ29kZVBpcGVsaW5lU3RhZ2VOYW1lXSxcbiAgICogIFwiQWN0aW9uTmFtZVwiOiBbTWFudWFsQXBwcm92YWxBY3Rpb25OYW1lXVxuICAgKiB9XG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgcHJlQXBwcm92ZUxhbWJkYTogbGFtYmRhLkZ1bmN0aW9uO1xuICAvKipcbiAgICogQSBDb2RlQnVpbGQgUHJvamVjdCB0aGF0IHJ1bnMgYSBzZWN1cml0eSBkaWZmIG9uIHRoZSBhcHBsaWNhdGlvbiBzdGFnZS5cbiAgICpcbiAgICogLSBJZiB0aGUgZGlmZiByZWdpc3RlcnMgbm8gc2VjdXJpdHkgY2hhbmdlcywgQ29kZUJ1aWxkIHdpbGwgaW52b2tlIHRoZVxuICAgKiAgIHByZS1hcHByb3ZhbCBsYW1iZGEgYW5kIGFwcHJvdmUgdGhlIE1hbnVhbEFwcHJvdmFsQWN0aW9uLlxuICAgKiAtIElmIGNoYW5nZXMgYXJlIGRldGVjdGVkLCBDb2RlQnVpbGQgd2lsbCBleGl0IGludG8gYSBNYW51YWxBcHByb3ZhbEFjdGlvblxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGNka0RpZmZQcm9qZWN0OiBjb2RlYnVpbGQuUHJvamVjdDtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogQXBwbGljYXRpb25TZWN1cml0eUNoZWNrUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgVGFncy5vZihwcm9wcy5jb2RlUGlwZWxpbmUpLmFkZCgnU0VDVVJJVFlfQ0hFQ0snLCAnQUxMT1dfQVBQUk9WRScsIHtcbiAgICAgIGluY2x1ZGVSZXNvdXJjZVR5cGVzOiBbJ0FXUzo6Q29kZVBpcGVsaW5lOjpQaXBlbGluZSddLFxuICAgIH0pO1xuXG4gICAgdGhpcy5wcmVBcHByb3ZlTGFtYmRhID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCAnQ0RLUGlwZWxpbmVzQXV0b0FwcHJvdmUnLCB7XG4gICAgICBoYW5kbGVyOiAnaW5kZXguaGFuZGxlcicsXG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMTRfWCxcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnYXBwcm92ZS1sYW1iZGEnKSksXG4gICAgICB0aW1lb3V0OiBEdXJhdGlvbi5taW51dGVzKDUpLFxuICAgIH0pO1xuXG4gICAgdGhpcy5wcmVBcHByb3ZlTGFtYmRhLmFkZFRvUm9sZVBvbGljeShuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICBhY3Rpb25zOiBbJ2NvZGVwaXBlbGluZTpHZXRQaXBlbGluZVN0YXRlJywgJ2NvZGVwaXBlbGluZTpQdXRBcHByb3ZhbFJlc3VsdCddLFxuICAgICAgY29uZGl0aW9uczoge1xuICAgICAgICBTdHJpbmdFcXVhbHM6IHtcbiAgICAgICAgICAnYXdzOlJlc291cmNlVGFnL1NFQ1VSSVRZX0NIRUNLJzogJ0FMTE9XX0FQUFJPVkUnLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIHJlc291cmNlczogWycqJ10sXG4gICAgfSkpO1xuXG4gICAgY29uc3QgaW52b2tlTGFtYmRhID1cbiAgICAgICdhd3MgbGFtYmRhIGludm9rZScgK1xuICAgICAgYCAtLWZ1bmN0aW9uLW5hbWUgJHt0aGlzLnByZUFwcHJvdmVMYW1iZGEuZnVuY3Rpb25OYW1lfWAgK1xuICAgICAgJyAtLWludm9jYXRpb24tdHlwZSBFdmVudCcgK1xuICAgICAgJyAtLXBheWxvYWQgXCIkcGF5bG9hZFwiJyArXG4gICAgICAnIGxhbWJkYS5vdXQnO1xuXG4gICAgY29uc3QgbWVzc2FnZSA9IFtcbiAgICAgICdBbiB1cGNvbWluZyBjaGFuZ2Ugd291bGQgYnJvYWRlbiBzZWN1cml0eSBjaGFuZ2VzIGluICRQSVBFTElORV9OQU1FLicsXG4gICAgICAnUmV2aWV3IGFuZCBhcHByb3ZlIHRoZSBjaGFuZ2VzIGluIENvZGVQaXBlbGluZSB0byBwcm9jZWVkIHdpdGggdGhlIGRlcGxveW1lbnQuJyxcbiAgICAgICcnLFxuICAgICAgJ1JldmlldyB0aGUgY2hhbmdlcyBpbiBDb2RlQnVpbGQ6JyxcbiAgICAgICcnLFxuICAgICAgJyRMSU5LJyxcbiAgICAgICcnLFxuICAgICAgJ0FwcHJvdmUgdGhlIGNoYW5nZXMgaW4gQ29kZVBpcGVsaW5lIChzdGFnZSAkU1RBR0VfTkFNRSwgYWN0aW9uICRBQ1RJT05fTkFNRSk6JyxcbiAgICAgICcnLFxuICAgICAgJyRQSVBFTElORV9MSU5LJyxcbiAgICBdO1xuICAgIGNvbnN0IHB1Ymxpc2hOb3RpZmljYXRpb24gPVxuICAgICAgJ2F3cyBzbnMgcHVibGlzaCcgK1xuICAgICAgJyAtLXRvcGljLWFybiAkTk9USUZJQ0FUSU9OX0FSTicgK1xuICAgICAgJyAtLXN1YmplY3QgXCIkTk9USUZJQ0FUSU9OX1NVQkpFQ1RcIicgK1xuICAgICAgYCAtLW1lc3NhZ2UgXCIke21lc3NhZ2Uuam9pbignXFxuJyl9XCJgO1xuXG4gICAgdGhpcy5jZGtEaWZmUHJvamVjdCA9IG5ldyBjb2RlYnVpbGQuUHJvamVjdCh0aGlzLCAnQ0RLU2VjdXJpdHlDaGVjaycsIHtcbiAgICAgIGJ1aWxkU3BlYzogY29kZWJ1aWxkLkJ1aWxkU3BlYy5mcm9tT2JqZWN0KHtcbiAgICAgICAgdmVyc2lvbjogMC4yLFxuICAgICAgICBwaGFzZXM6IHtcbiAgICAgICAgICBidWlsZDoge1xuICAgICAgICAgICAgY29tbWFuZHM6IFtcbiAgICAgICAgICAgICAgJ25wbSBpbnN0YWxsIC1nIGF3cy1jZGsnLFxuICAgICAgICAgICAgICAvLyAkQ09ERUJVSUxEX0lOSVRJQVRPUiB3aWxsIGFsd2F5cyBiZSBDb2RlIFBpcGVsaW5lIGFuZCBpbiB0aGUgZm9ybSBvZjpcbiAgICAgICAgICAgICAgLy8gXCJjb2RlcGlwZWxpbmUvZXhhbXBsZS1waXBlbGluZS1uYW1lLVh4eFwiXG4gICAgICAgICAgICAgICdleHBvcnQgUElQRUxJTkVfTkFNRT1cIiQobm9kZSAtcGUgXFwnYCR7cHJvY2Vzcy5lbnYuQ09ERUJVSUxEX0lOSVRJQVRPUn1gLnNwbGl0KFwiL1wiKVsxXVxcJylcIicsXG4gICAgICAgICAgICAgICdwYXlsb2FkPVwiJChub2RlIC1wZSBcXCdKU09OLnN0cmluZ2lmeSh7IFwiUGlwZWxpbmVOYW1lXCI6IHByb2Nlc3MuZW52LlBJUEVMSU5FX05BTUUsIFwiU3RhZ2VOYW1lXCI6IHByb2Nlc3MuZW52LlNUQUdFX05BTUUsIFwiQWN0aW9uTmFtZVwiOiBwcm9jZXNzLmVudi5BQ1RJT05fTkFNRSB9KVxcJyApXCInLFxuICAgICAgICAgICAgICAvLyBBUk46IFwiYXJuOmF3czpjb2RlYnVpbGQ6JHJlZ2lvbjokYWNjb3VudF9pZDpidWlsZC8kcHJvamVjdF9uYW1lOiRwcm9qZWN0X2V4ZWN1dGlvbl9pZCRcIlxuICAgICAgICAgICAgICAnQVJOPSRDT0RFQlVJTERfQlVJTERfQVJOJyxcbiAgICAgICAgICAgICAgJ1JFR0lPTj1cIiQobm9kZSAtcGUgXFwnYCR7cHJvY2Vzcy5lbnYuQVJOfWAuc3BsaXQoXCI6XCIpWzNdXFwnKVwiJyxcbiAgICAgICAgICAgICAgJ0FDQ09VTlRfSUQ9XCIkKG5vZGUgLXBlIFxcJ2Ake3Byb2Nlc3MuZW52LkFSTn1gLnNwbGl0KFwiOlwiKVs0XVxcJylcIicsXG4gICAgICAgICAgICAgICdQUk9KRUNUX05BTUU9XCIkKG5vZGUgLXBlIFxcJ2Ake3Byb2Nlc3MuZW52LkFSTn1gLnNwbGl0KFwiOlwiKVs1XS5zcGxpdChcIi9cIilbMV1cXCcpXCInLFxuICAgICAgICAgICAgICAnUFJPSkVDVF9JRD1cIiQobm9kZSAtcGUgXFwnYCR7cHJvY2Vzcy5lbnYuQVJOfWAuc3BsaXQoXCI6XCIpWzZdXFwnKVwiJyxcbiAgICAgICAgICAgICAgLy8gTWFudWFsIEFwcHJvdmFsIGFkZHMgJ2h0dHAvaHR0cHMnIHRvIHRoZSByZXNvbHZlZCBsaW5rXG4gICAgICAgICAgICAgICdleHBvcnQgTElOSz1cImh0dHBzOi8vJFJFR0lPTi5jb25zb2xlLmF3cy5hbWF6b24uY29tL2NvZGVzdWl0ZS9jb2RlYnVpbGQvJEFDQ09VTlRfSUQvcHJvamVjdHMvJFBST0pFQ1RfTkFNRS9idWlsZC8kUFJPSkVDVF9OQU1FOiRQUk9KRUNUX0lELz9yZWdpb249JFJFR0lPTlwiJyxcbiAgICAgICAgICAgICAgJ2V4cG9ydCBQSVBFTElORV9MSU5LPVwiaHR0cHM6Ly8kUkVHSU9OLmNvbnNvbGUuYXdzLmFtYXpvbi5jb20vY29kZXN1aXRlL2NvZGVwaXBlbGluZS9waXBlbGluZXMvJFBJUEVMSU5FX05BTUUvdmlldz9yZWdpb249JFJFR0lPTlwiJyxcbiAgICAgICAgICAgICAgLy8gUnVuIGludm9rZSBvbmx5IGlmIGNkayBkaWZmIHBhc3NlcyAocmV0dXJucyBleGl0IGNvZGUgMClcbiAgICAgICAgICAgICAgLy8gMCAtPiB0cnVlLCAxIC0+IGZhbHNlXG4gICAgICAgICAgICAgIGlmRWxzZSh7XG4gICAgICAgICAgICAgICAgY29uZGl0aW9uOiAnY2RrIGRpZmYgLWEgLiAtLXNlY3VyaXR5LW9ubHkgLS1mYWlsICRTVEFHRV9QQVRIL1xcXFwqJyxcbiAgICAgICAgICAgICAgICB0aGVuU3RhdGVtZW50czogW1xuICAgICAgICAgICAgICAgICAgaW52b2tlTGFtYmRhLFxuICAgICAgICAgICAgICAgICAgJ2V4cG9ydCBNRVNTQUdFPVwiTm8gc2VjdXJpdHktaW1wYWN0aW5nIGNoYW5nZXMgZGV0ZWN0ZWQuXCInLFxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgZWxzZVN0YXRlbWVudHM6IFtcbiAgICAgICAgICAgICAgICAgIGBbIC16IFwiXFwke05PVElGSUNBVElPTl9BUk59XCIgXSB8fCAke3B1Ymxpc2hOb3RpZmljYXRpb259YCxcbiAgICAgICAgICAgICAgICAgICdleHBvcnQgTUVTU0FHRT1cIkRlcGxveW1lbnQgd291bGQgbWFrZSBzZWN1cml0eS1pbXBhY3RpbmcgY2hhbmdlcy4gQ2xpY2sgdGhlIGxpbmsgYmVsb3cgdG8gaW5zcGVjdCB0aGVtLCB0aGVuIGNsaWNrIEFwcHJvdmUgaWYgYWxsIGNoYW5nZXMgYXJlIGV4cGVjdGVkLlwiJyxcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgZW52OiB7XG4gICAgICAgICAgJ2V4cG9ydGVkLXZhcmlhYmxlcyc6IFtcbiAgICAgICAgICAgICdMSU5LJyxcbiAgICAgICAgICAgICdNRVNTQUdFJyxcbiAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgfSk7XG5cbiAgICAvLyB0aGlzIGlzIG5lZWRlZCB0byBjaGVjayB0aGUgc3RhdHVzIHRoZSBzdGFja3Mgd2hlbiBkb2luZyBgY2RrIGRpZmZgXG4gICAgdGhpcy5jZGtEaWZmUHJvamVjdC5hZGRUb1JvbGVQb2xpY3kobmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgYWN0aW9uczogWydzdHM6QXNzdW1lUm9sZSddLFxuICAgICAgcmVzb3VyY2VzOiBbJyonXSxcbiAgICAgIGNvbmRpdGlvbnM6IHtcbiAgICAgICAgJ0ZvckFueVZhbHVlOlN0cmluZ0VxdWFscyc6IHtcbiAgICAgICAgICAnaWFtOlJlc291cmNlVGFnL2F3cy1jZGs6Ym9vdHN0cmFwLXJvbGUnOiBbJ2RlcGxveSddLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICB9KSk7XG5cbiAgICB0aGlzLnByZUFwcHJvdmVMYW1iZGEuZ3JhbnRJbnZva2UodGhpcy5jZGtEaWZmUHJvamVjdCk7XG4gIH1cbn1cblxuaW50ZXJmYWNlIGlmRWxzZU9wdGlvbnMge1xuICByZWFkb25seSBjb25kaXRpb246IHN0cmluZyxcbiAgcmVhZG9ubHkgdGhlblN0YXRlbWVudHM6IHN0cmluZ1tdLFxuICByZWFkb25seSBlbHNlU3RhdGVtZW50cz86IHN0cmluZ1tdXG59XG5cbmNvbnN0IGlmRWxzZSA9ICh7IGNvbmRpdGlvbiwgdGhlblN0YXRlbWVudHMsIGVsc2VTdGF0ZW1lbnRzIH06IGlmRWxzZU9wdGlvbnMpOiBzdHJpbmcgPT4ge1xuICBsZXQgc3RhdGVtZW50ID0gdGhlblN0YXRlbWVudHMucmVkdWNlKChhY2MsIGlmVHJ1ZSkgPT4ge1xuICAgIHJldHVybiBgJHthY2N9ICR7aWZUcnVlfTtgO1xuICB9LCBgaWYgJHtjb25kaXRpb259OyB0aGVuYCk7XG5cbiAgaWYgKGVsc2VTdGF0ZW1lbnRzKSB7XG4gICAgc3RhdGVtZW50ID0gZWxzZVN0YXRlbWVudHMucmVkdWNlKChhY2MsIGlmRmFsc2UpID0+IHtcbiAgICAgIHJldHVybiBgJHthY2N9ICR7aWZGYWxzZX07YDtcbiAgICB9LCBgJHtzdGF0ZW1lbnR9IGVsc2VgKTtcbiAgfVxuXG4gIHJldHVybiBgJHtzdGF0ZW1lbnR9IGZpYDtcbn07Il19